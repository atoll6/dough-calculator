<!doctype html>
<html lang="en">
<head>
    <meta name="author" content="Arda Tolan">
    <meta name="description" content="A Pizza-dough calculator">
    <meta name="viewport" content="width=device-width">
    <meta name="color-scheme" content="light dark">
    <link rel="shortcut icon" type="image/png" href="favicon.png"/>
    <link rel="stylesheet" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script>dayjs().format()</script>
    <title>Arda's Pizza-dough Calculator</title>
</head>
<body>
<main>
    <h2>Original 24-hour Pizza Dough</h2>
    <!-- DateTime Picker -->
    <section class="timeModule">
        <label>Planned Date to Eat
            <input type="text" id="inputDate">
        </label>
        <label>Time
            <input type="text" id="inputTime">
        </label>
    </section>
    <section>
        <label>Portions
            <input type="number" inputmode="numeric" id="inputPortions" value="2"> balls
        </label>
        <label>Portion Size
            <input type="number" inputmode="numeric" id="inputPortionSize" value="260"> g
        </label>
        <label>Hydration
            <input type="number" inputmode="numeric" id="inputHydration" value="70"> %
        </label>
        <label>Salt
            <input type="number" inputmode="numeric" id="inputSalt" value="3"> %
        </label>
    </section>
    <section>
    <div id="portion-warning" style="display:none;">
            The poolish amount of 300:300 is ideal for portions up to 12. For more portions, I recommend splitting the recipe in 2 or more!
        </div>
        <h2>Final Result:</h2>
        <label>Total Dough Weight (g)
            <input type="text" id="inputTotalDoughWeight" disabled readonly>
        </label>
        <label>Total Flour Weight (g)
            <input type="text" id="inputFlour" disabled readonly>
        </label>
        <label>Total Water (g)
            <input type="text" id="inputWater" disabled readonly>
        </label>
        <label>Total Salt (g)
            <input type="text" id="inputSaltAmount" disabled readonly>
        </label>
    </section>
    <section>
        <h2>Step 1 - Make the poolish:</h2>
        <p class="timeModule" id="labelDateTimeToStart"></p>
        <label>Flour (g)
            <input type="text" id="inputPoolishFlour" disabled readonly>
        </label>
        <label>Water (g)
            <input type="text" id="inputPoolishWater" disabled readonly>
        </label>
        <label>Instant Yeast (g)
            <input type="text" id="inputPoolishYeast" disabled readonly>
        </label>
        <label>Honey (g)
            <input type="text" id="inputPoolishHoney" disabled readonly>
        </label>
        <ul>
            <li><input type="checkbox" id="poolish-step1"> <label for="poolish-step1">Mix and let sit for 1 hour at room temperature.</label></li>
            <li><input type="checkbox" id="poolish-step2"> <label for="poolish-step2">Refrigerate for 16-24 hrs (until the time below, depending on when you started)</label></li>
        </ul>
    </section>
    <section>
        <h2>Step 2 - Final Mix:</h2>
        <p class="timeModule" id="labelStep2DateTime"></p>
        <ul>
            <li><input type="checkbox" id="step2"> <label for="step2">Add the following to your fermented poolish, and continue to the final steps</label></li>
        </ul>
        <label>Flour (g)
            <input type="text" id="inputRemainingFlour" disabled readonly>
        </label>
        <label>Water (g)
            <input type="text" id="inputRemainingWater" disabled readonly>
        </label>
        <label>Salt (g)
            <input type="text" id="inputRemainingSalt" disabled readonly>
        </label>
    </section>
    <section>
        <h2>Final Steps:</h2>
        <ul>
            <li><input type="checkbox" id="final-step1"> <label for="final-step1">Mix all together by hand or mixer</label></li>
            <li><input type="checkbox" id="final-step2"> <label for="final-step2">Cover and let rest for 20-30 minutes (autolyse)</label></li>
            <li><input type="checkbox" id="final-step3"> <label for="final-step3">Knead dough and form into ball. Don't worry if dough is still sticky at this stage.</label></li>
            <li><input type="checkbox" id="final-step4"> <label for="final-step4">Cover and let rest another 15-20 minutes. Dough will be easier to work with after this period. Dough should be smooth on the surface, bounce back when poked, and pass the windowpane test.</label></li>
            <li><input type="checkbox" id="final-step5"> <label for="final-step5">Split by portion weight and form into balls</label></li>
            <li><input type="checkbox" id="final-step6"> <label for="final-step6">Place on tray and cover with cling-film or cover container with lid. Let rest 1 - 2 hours until dough doubles in size. This could vary depending on your room temperature.</label></li>
            <li><input type="checkbox" id="final-step7"> <label for="final-step7">Form pizza bases and bake!</label></li>
        </ul>
    </section>
</main>
<div class="top-bar">
    <div class="top-bar-left">
        <a href="https://atoll6.github.io/" id="backBtn" style="text-decoration:none;"><button type="button">&#8592; Back</button></a>
    </div>
    <div class="top-bar-right">
        <button id="resetFormBtn" type="button">New Pizza</button>
    </div>
</div>
<script>
function refresh_data() {
    var portionSize = parseInt($("#inputPortionSize").val());
    var portions = parseInt($("#inputPortions").val());
    var hydration = parseInt($("#inputHydration").val());
    var salt = parseFloat($("#inputSalt").val());
    var totalDoughWeight = Math.round( portions * portionSize );
    var flourWeight = Math.round( totalDoughWeight / ((hydration/100) + (salt/100)+1));
    var waterWeight = Math.round((hydration / 100) * flourWeight);
    var saltWeight = Math.round( (salt / 100) * flourWeight);
    var dateTimeString = $("#inputDate").val() + " " + $("#inputTime").val();
    var eatDateTime = dayjs(dateTimeString);
    var step2DateTime = dayjs(eatDateTime).subtract(2, 'hour');
    var step2StartTime = dayjs(step2DateTime).format("ddd, DD-MMM-YYYY HH:mm");
    var step2EarliestDateTime = dayjs(eatDateTime).subtract(3, 'hour');
    var step2EarliestStartTime = dayjs(step2EarliestDateTime).format("ddd, DD-MMM-YYYY HH:mm");
    $("#labelStep2DateTime").html("<i class='bi bi-clock'></i> Recommended time to start: <b>" + step2EarliestStartTime + "</b> and <b>" + step2StartTime + "</b>");
    var latestStartDateTime = dayjs(eatDateTime).subtract(17+3, 'hour').format("ddd, DD-MMM-YYYY HH:mm");
    var earliestStartDateTime = dayjs(eatDateTime).subtract(25+3, 'hour').format("ddd, DD-MMM-YYYY HH:mm");
    $("#labelDateTimeToStart").html("<i class='bi bi-clock'></i> Recommended time to start: Between <b>" + earliestStartDateTime + "</b> and <b>" + latestStartDateTime + "</b>");
    if (portions > 12) {
        $("#portion-warning").show();
    }
    else {
        $("#portion-warning").hide();
    }
        // Poolish (starter) is always 300g flour, 300g water, 5g honey, 5g yeast
        var poolishFlourWeight = 300;
        var poolishWaterWeight = 300;
        var poolishHoneyWeight = 5;
        var poolishYeastWeight = 5;

        // Remaining ingredients
        var remainingFlour = Math.max(0, Math.round(flourWeight - poolishFlourWeight));
        var remainingWater = Math.max(0, Math.round(waterWeight - poolishWaterWeight));
        var remainingSalt = Math.round(saltWeight);

        // Set poolish values in UI
        $("#inputPoolishFlour").val(poolishFlourWeight);
        $("#inputPoolishWater").val(poolishWaterWeight);
        $("#inputPoolishYeast").val(poolishYeastWeight);
        $("#inputPoolishHoney").val(poolishHoneyWeight);

        // Set remaining values in UI
        $("#inputTotalDoughWeight").val(totalDoughWeight);
        $("#inputFlour").val(flourWeight);
        $("#inputWater").val(waterWeight);
        $("#inputSaltAmount").val(saltWeight);
        $("#inputRemainingFlour").val(remainingFlour);
        $("#inputRemainingWater").val(remainingWater);
        $("#inputRemainingSalt").val(remainingSalt);
}
// Save all input and checkbox values to localStorage
function saveFormState() {
    $("input").each(function() {
        var $el = $(this);
        var id = $el.attr("id");
        if (!id) return;
        if ($el.attr("type") === "checkbox") {
            localStorage.setItem("doughcalc_" + id, $el.prop("checked"));
        } else {
            localStorage.setItem("doughcalc_" + id, $el.val());
        }
    });
}

// Restore all input and checkbox values from localStorage
function restoreFormState() {
    $("input").each(function() {
        var $el = $(this);
        var id = $el.attr("id");
        if (!id) return;
        if ($el.attr("type") === "checkbox") {
            var val = localStorage.getItem("doughcalc_" + id);
            if (val !== null) $el.prop("checked", val === "true");
        } else {
            var val = localStorage.getItem("doughcalc_" + id);
            if (val !== null) $el.val(val);
        }
    });
}

$("input").on("keyup change", function() {
    refresh_data();
    saveFormState();
});

$(document).ready(function() {
    // Reset button handler
    $("#resetFormBtn").on("click", function() {
        // Set all user-editable fields to their default values
        if (!$("#inputDate").prop("disabled") && !$("#inputDate").prop("readonly")) {
            var today = dayjs().format('YYYY-MM-DD');
            $("#inputDate").val(today);
        }
        if (!$("#inputTime").prop("disabled") && !$("#inputTime").prop("readonly")) {
            var defaultTime = (dayjs().hour() + 25) % 24;
            var defaultTimeStr = (defaultTime < 10 ? '0' : '') + defaultTime + ':00';
            $("#inputTime").val(defaultTimeStr);
        }
        if (!$("#inputPortions").prop("disabled") && !$("#inputPortions").prop("readonly")) {
            $("#inputPortions").val("2");
        }
        if (!$("#inputPortionSize").prop("disabled") && !$("#inputPortionSize").prop("readonly")) {
            $("#inputPortionSize").val("260");
        }
        if (!$("#inputHydration").prop("disabled") && !$("#inputHydration").prop("readonly")) {
            $("#inputHydration").val("70");
        }
        if (!$("#inputSalt").prop("disabled") && !$("#inputSalt").prop("readonly")) {
            $("#inputSalt").val("3");
        }
        // Uncheck all checkboxes
        $("input[type='checkbox']").prop("checked", false);
        // Remove saved state
        Object.keys(localStorage).forEach(function(key) {
            if (key.startsWith("doughcalc_")) {
                localStorage.removeItem(key);
            }
        });
        // Optionally, reset date/time to defaults
        var today = dayjs().format('YYYY-MM-DD');
        var defaultTime = (dayjs().hour() + 25) % 24;
        var defaultTimeStr = (defaultTime < 10 ? '0' : '') + defaultTime + ':00';
        $("#inputDate").val(today);
        $("#inputTime").val(defaultTimeStr);
        refresh_data();
    });
    // Set defaults only if not already saved
    var today = dayjs().format('YYYY-MM-DD');
    var defaultTime = (dayjs().hour() + 25) % 24;
    var defaultTimeStr = (defaultTime < 10 ? '0' : '') + defaultTime + ':00';
    if (!localStorage.getItem("doughcalc_inputDate")) {
        $("#inputDate").val(today);
    }
    if (!localStorage.getItem("doughcalc_inputTime")) {
        $("#inputTime").val(defaultTimeStr);
    }
    restoreFormState();
    $("#inputDate").flatpickr({
        minDate: "today"
    });
    $("#inputTime").flatpickr({
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i",
        time_24hr: true
    });
    refresh_data();
});
</script>
</body>
</html>
